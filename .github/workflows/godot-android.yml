name: Godot Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1) JDK 17 để setup-android chạy
      - name: Set up Java 17 (for Android SDK)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      # 2) Cài Android SDK
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        env:
          SKIP_JDK_VERSION_CHECK: true

      # 3) Cài các gói SDK cần thiết
      - name: Install Android SDK components
        shell: bash
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          set -e
          SDKMGR="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
          yes | "$SDKMGR" --licenses || true
          "$SDKMGR" --sdk_root="$ANDROID_SDK_ROOT" \
            "platform-tools" \
            "build-tools;33.0.2" \
            "platforms;android-33"

      # 4) Tải Godot headless + templates
      - name: Download Godot headless + templates
        run: |
          mkdir -p "$HOME/.local/share/godot/templates/3.5.3.stable"
          curl -L -o godot.zip https://github.com/godotengine/godot-builds/releases/download/3.5.3-stable/Godot_v3.5.3-stable_linux_headless.64.zip
          unzip -q godot.zip -d godot_bin
          mv godot_bin/Godot_v3.5.3-stable_linux_headless.64 godot
          chmod +x godot
          curl -L -o templates.tpz https://github.com/godotengine/godot-builds/releases/download/3.5.3-stable/Godot_v3.5.3-stable_export_templates.tpz
          unzip -q templates.tpz -d "$HOME/.local/share/godot/templates/3.5.3.stable"

      # 5) ĐẶT ĐÚNG SDK PATH + ADB CHO GODOT (EditorSettings keys của Godot 3.x)
      - name: Configure Godot EditorSettings (SDK path + ADB)
        run: |
          SDK="/usr/local/lib/android/sdk"
          ADB="$SDK/platform-tools/adb"
          ./godot --headless --editor --quit --set export/android/sdk_path "$SDK"
          ./godot --headless --editor --quit --set export/android/adb "$ADB"
          tail -n 100 "$HOME/.config/godot/editor_settings-3.tres" || true

      # 6) (QUAN TRỌNG) GHI ĐÈ export_presets.cfg CHUẨN — preset name = "Android"
      - name: Ensure export_presets.cfg (Android preset)
        run: |
          cat > export_presets.cfg <<'EOF'
          [preset.0]
          name="Android"
          platform="Android"
          runnable=true
          custom_features=""
          export_filter="all_resources"
          include_filter=""
          exclude_filter=""
          export_path="build/android/OfflineRPG.apk"
          script_export_mode=1
          script_encryption_key=""
          advanced_options=false

          [preset.0.options]
          package/unique_name="com.example.offlinerpg"
          version/code=1
          version/name="1.0.0"
          architectures/armeabi-v7a=true
          architectures/arm64-v8a=true
          architectures/x86=false
          architectures/x86_64=false
          gradle_build/use_gradle_build=true
          gradle_build/use_androidx=true
          keystore/debug=""
          keystore/debug_user=""
          keystore/debug_password=""
          keystore/release=""
          keystore/release_user=""
          keystore/release_password=""
          one_click_deploy/android_sdk_path=""
          permissions/Internet=false
          apk_expansion/enable=false
          EOF

          echo "=== Detected presets ==="
          grep -E '^\[preset|^name=' -n export_presets.cfg || true

      # 7) Tạo debug.keystore & set vào EditorSettings (một số bản Godot 3 cần)
      - name: Create and set Android debug keystore
        run: |
          mkdir -p "$HOME/.android"
          if [ ! -f "$HOME/.android/debug.keystore" ]; then
            keytool -genkeypair -noprompt \
              -alias androiddebugkey \
              -keystore "$HOME/.android/debug.keystore" \
              -storepass android -keypass android \
              -dname "CN=Android Debug,O=Android,C=US" \
              -keyalg RSA -keysize 2048 -validity 10000
          fi
          ./godot --headless --editor --quit --set export/android/debug_keystore "$HOME/.android/debug.keystore"
          ./godot --headless --editor --quit --set export/android/debug_keystore_user "androiddebugkey"
          ./godot --headless --editor --quit --set export/android/debug_keystore_pass "android"

      # 8) Chuyển về JDK 11 cho Gradle Godot 3.x
      - name: Switch to Java 11 (for Godot Gradle build)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'

      # 9) Cài Android build template
      - name: Install Android build template
        run: ./godot --headless --path . --quit --install-android-build-template

      # 10) Export APK (dùng ĐÚNG tên preset "Android")
      - name: Export Android APK
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
          ANDROID_HOME: /usr/local/lib/android/sdk
        run: |
          mkdir -p build/android
          ./godot -v --headless --path . --export-release "Android" build/android/OfflineRPG.apk
          ls -lah build/android

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: OfflineRPG-apk
          path: build/android/*.apk
